.PHONY: help
.DEFAULT_GOAL := help
BATS_VERSION = "v1.1.0"
LTS_ALPINE ?= 12-alpine

help: ## Display this help text
	@grep -E '^[a-zA-Z_-]+[%]?:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

bats: ## Install bats in the project itself
	@test -e "bats-core" && (cd bats-core ; git checkout ${BATS_VERSION}) || git clone https://github.com/bats-core/bats-core.git --depth=1 --branch ${BATS_VERSION}

prepare-test: bats ## Prepare the bats dependencies
	@docker pull node:${LTS_ALPINE}
	@mkdir -p target
	@git submodule sync
	@git submodule update --init --recursive

test-%: prepare-test ## Run the tests for the specific app
	@DOCKERFILE=$* bats-core/bin/bats --tap tests | tee target/results.tap
	@APP=$*; docker run --rm -e APP=$${APP} -v "$(CURDIR)":/usr/src/app -w /usr/src/app node:${LTS_ALPINE} \
					sh -c 'npm install tap-xunit -g && cat target/results.tap | tap-xunit --package="co.elastic.apm.integration.testing.$${APP}" > target/junit-$${APP}-results.xml'

push-%: prepare-test ## Push the Docker image to the docker.elastic.co repository
	docker push "docker.elastic.co/observability-ci/it_$*"

all-opbeans-tests: test-opbeans-dotnet test-opbeans-frontend_nginx test-opbeans-go test-opbeans-java test-opbeans-node test-opbeans-python test-opbeans-ruby test-opbeans-rum ## Run the tests for all the opbeans

all-tests: test-apm-server all-opbeans-tests ## Run the tests for all the apps

all-push: push-apm-server push-opbeans-dotnet push-opbeans-frontend_nginx push-opbeans-go push-opbeans-java push-opbeans-node push-opbeans-python push-opbeans-ruby push-opbeans-rum ## Push Docker images to the registry.

clean: ## Clean autogenerated files/folders
	@rm -rf bats-core
	@rm -rf target
