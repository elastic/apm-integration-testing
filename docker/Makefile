.PHONY: help
.DEFAULT_GOAL := help

LTS_ALPINE ?= 12-alpine

help: ## Display this help text
	@grep -E '^[a-zA-Z_-]+[%]?:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

build-%: ## Build docker image for the app
	@docker build $*

bats: ## Install bats in the project itself
	@git clone https://github.com/sstephenson/bats.git

prepare-test: bats ## Prepare the bats dependencies
	@docker pull node:${LTS_ALPINE}
	@mkdir -p target
	@git submodule sync
	@git submodule update --init --recursive

test-apps-%: prepare-test ## Run the tests for the app
	@DOCKERFILE=$* bats/bin/bats --tap tests | tee target/results.tap
	@APP=$*; docker run --rm -e APP=$${APP} -v "${PWD}":/usr/src/app -w /usr/src/app node:${LTS_ALPINE} \
					sh -c 'npm install tap-xunit -g && cat docker/target/results.tap | tap-xunit --package="co.elastic.apm.integration.testing.$${APP}" > docker/target/junit-$${APP}-results.xml'

test-opbeans-%: prepare-test ## Run the tests for the opbeans
	@DOCKERFILE=opbeans/$* bats/bin/bats --tap tests | tee target/results.tap
	@APP=$*; docker run --rm -e APP=$${APP} -v "${PWD}":/usr/src/app -w /usr/src/app node:${LTS_ALPINE} \
					sh -c 'npm install tap-xunit -g && cat docker/target/results.tap | tap-xunit --package="co.elastic.apm.integration.testing.opbeans.$${APP}" > docker/target/junit-opbeans-$${APP}-results.xml'

test-agents-%: prepare-test ## Run the tests for the app
	@APP=$*; DOCKERFILE=$${APP//-/\/} bats/bin/bats --tap tests | tee target/results.tap
	@APP=$*; docker run --rm -e APP=$${APP} -v "${PWD}":/usr/src/app -w /usr/src/app node:${LTS_ALPINE} \
					sh -c 'npm install tap-xunit -g && cat docker/target/results.tap | tap-xunit --package="co.elastic.apm.integration.testing.agents.$${APP}" > docker/target/junit-agents-$${APP}-results.xml'

all-tests: test-apps-apm-server test-agents-dotnet test-agents-go-nethttp test-agents-java-spring test-agents-nodejs-express test-agents-python-django test-agents-python-flask test-agents-ruby-rails test-opbeans-dotnet test-opbeans-frontend test-opbeans-go test-opbeans-java test-opbeans-node test-opbeans-python test-opbeans-ruby test-opbeans-rum ## Run the tests for all the apps
	echo 'done'

clean: ## Clean autogenerated files/folders
	@rm -rf bats
	@rm -rf target
